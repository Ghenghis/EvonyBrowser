name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 7.0.3)'
        required: true
        default: '7.0.3'

env:
  NODE_VERSION: '18.x'
  PROJECT_PATH: SvonyBrowser/SvonyBrowser.csproj

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout LFS objects
      run: git lfs pull

    - name: Get Version
      id: version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: pwsh

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.config') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore NuGet packages
      run: |
        nuget restore ${{ env.PROJECT_PATH }} -PackagesDirectory packages

    - name: Build Release
      run: |
        msbuild ${{ env.PROJECT_PATH }} /t:Build /p:Configuration=Release /p:Platform=x64
      continue-on-error: true

    - name: Copy Assets to Output
      run: |
        $outputPath = "SvonyBrowser/bin/x64/Release"
        $assetsPath = "release/Assets"
        if (Test-Path $assetsPath) {
          Copy-Item -Path "$assetsPath/*" -Destination "$outputPath/Assets" -Recurse -Force
          Write-Host "Copied Assets to output directory"
        }
      shell: pwsh
      continue-on-error: true

    - name: Prepare Release Package
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $outputPath = "SvonyBrowser/bin/x64/Release"
        $releasePath = "release-package"
        
        # Create release directory
        New-Item -ItemType Directory -Path $releasePath -Force
        
        # Copy build output if exists
        if (Test-Path $outputPath) {
          Copy-Item -Path "$outputPath/*" -Destination $releasePath -Recurse -Force
        }
        
        # Copy Assets folder
        if (Test-Path "release/Assets") {
          Copy-Item -Path "release/Assets" -Destination "$releasePath/Assets" -Recurse -Force
        }
        
        # Copy documentation
        if (Test-Path "docs") {
          Copy-Item -Path "docs" -Destination "$releasePath/docs" -Recurse -Force
        }
        
        # Copy README
        if (Test-Path "README.md") {
          Copy-Item -Path "README.md" -Destination $releasePath -Force
        }
        
        Write-Host "Release package contents:"
        Get-ChildItem $releasePath -Recurse | Select-Object FullName
      shell: pwsh

    - name: Verify Assets
      run: |
        Write-Host "=== Verifying Assets ==="
        $assetsPath = "release-package/Assets"
        if (Test-Path $assetsPath) {
          Write-Host "Assets folder found"
          Get-ChildItem $assetsPath -Recurse | Select-Object -First 20 FullName
        } else {
          Write-Host "Assets folder not found at $assetsPath"
        }
      shell: pwsh

    - name: Build MCP Servers
      run: |
        $servers = @("evony-complete", "evony-rag", "evony-rte", "evony-tools", "evony-advanced", "evony-cdp", "evony-v4")
        foreach ($server in $servers) {
          $path = "mcp-servers/$server"
          if (Test-Path $path) {
            Push-Location $path
            npm install --production
            Pop-Location
          }
        }
      shell: pwsh
      continue-on-error: true

    - name: Create Archives
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        
        # Create main release archive
        if ((Test-Path "release-package") -and (Get-ChildItem "release-package" -ErrorAction SilentlyContinue)) {
          Compress-Archive -Path ./release-package/* -DestinationPath ./EvonyBrowser-v$version-win-x64.zip -Force
          Write-Host "Created EvonyBrowser-v$version-win-x64.zip"
        } else {
          Write-Host "No release-package contents to archive"
        }
        
        # Create Assets-only archive
        if ((Test-Path "release/Assets") -and (Get-ChildItem "release/Assets" -ErrorAction SilentlyContinue)) {
          Compress-Archive -Path ./release/Assets/* -DestinationPath ./EvonyBrowser-v$version-assets.zip -Force
          Write-Host "Created EvonyBrowser-v$version-assets.zip"
        } else {
          Write-Host "No Assets to archive"
        }
        
        # Create source archive (always should work)
        $excludePatterns = @(".git", "release-package", "*.zip", "bin", "obj", "node_modules", "packages")
        Get-ChildItem -Exclude $excludePatterns | Compress-Archive -DestinationPath ./EvonyBrowser-v$version-source.zip -Force
        Write-Host "Created EvonyBrowser-v$version-source.zip"
      shell: pwsh
      continue-on-error: true

    - name: List Build Artifacts
      run: |
        Write-Host "=== Build Artifacts ==="
        Get-ChildItem -Path . -Filter "*.zip" | ForEach-Object { 
          $size = [math]::Round($_.Length / 1MB, 2)
          Write-Host "$($_.Name) ($size MB)"
        }
      shell: pwsh

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Evony Browser v${{ steps.version.outputs.VERSION }}
        body: |
          ## üè∞ Evony Browser v${{ steps.version.outputs.VERSION }}
          
          ### Downloads
          - **Windows x64**: Full application with CefSharp and Flash support
          - **Assets**: CefSharp DLLs, Flash plugin, and resources only
          - **Source**: Full source code
          
          ### What's New
          - **SWF Loading Implementation** - CefFlashBrowser-style asset loading
          - **SwfPlayerWindow** - Dedicated window for SWF file playback
          - **Flash Plugin Support** - pepflashplayer.dll v32.0.0.465
          - **Git LFS** - Large binary files tracked properly
          
          ### Features
          - CefSharp 84.4.10 with Flash Player support
          - Dual-panel browser for Evony gameplay
          - Session synchronization between panels
          - MCP server integration
          - Protocol analysis tools
          
          
          ### Requirements
          - Windows 10/11 (64-bit)
          - Visual C++ Redistributable 2019 or later
          - Node.js 18+ (for MCP servers)
          - Flash Player PPAPI plugin (for Evony)
          
          See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for full documentation.
        files: |
          ./EvonyBrowser-v${{ steps.version.outputs.VERSION }}-win-x64.zip
          ./EvonyBrowser-v${{ steps.version.outputs.VERSION }}-assets.zip
          ./EvonyBrowser-v${{ steps.version.outputs.VERSION }}-source.zip
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
