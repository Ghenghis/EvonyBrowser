name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 7.0.4)'
        required: true
        default: '7.0.4'

env:
  NODE_VERSION: '18.x'
  PROJECT_PATH: SvonyBrowser/SvonyBrowser.csproj

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        configuration: [Release, Debug]
        platform: [x64, x86]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout LFS objects
      run: git lfs pull

    - name: Get Version
      id: version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: pwsh

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Clear NuGet cache and restore packages
      run: |
        Write-Host "=== Clearing NuGet cache ==="
        nuget locals all -clear
        
        Write-Host "`n=== Removing existing packages folder ==="
        if (Test-Path packages) { Remove-Item packages -Recurse -Force }
        
        Write-Host "`n=== Installing packages fresh ==="
        nuget install CefSharp.Common -Version 84.4.10 -OutputDirectory packages -NoCache
        nuget install CefSharp.Wpf -Version 84.4.10 -OutputDirectory packages -NoCache
        nuget install cef.redist.x64 -Version 84.4.1 -OutputDirectory packages -NoCache
        nuget install cef.redist.x86 -Version 84.4.1 -OutputDirectory packages -NoCache
        nuget install Newtonsoft.Json -Version 13.0.3 -OutputDirectory packages
        nuget install Serilog -Version 2.12.0 -OutputDirectory packages
        nuget install Serilog.Sinks.Console -Version 4.1.0 -OutputDirectory packages
        nuget install Serilog.Sinks.File -Version 5.0.0 -OutputDirectory packages
        nuget install System.ValueTuple -Version 4.5.0 -OutputDirectory packages
        
        Write-Host "`n=== Verifying CefSharp DLLs ==="
        $cefDll = "packages/CefSharp.Common.84.4.10/CefSharp/x64/CefSharp.dll"
        if (Test-Path $cefDll) { Write-Host "SUCCESS: CefSharp.dll found" } else { Write-Host "FAILED: CefSharp.dll not found"; exit 1 }
      shell: pwsh

    - name: Build ${{ matrix.configuration }} ${{ matrix.platform }}
      run: |
        msbuild ${{ env.PROJECT_PATH }} /t:Rebuild /p:Configuration=${{ matrix.configuration }} /p:Platform=${{ matrix.platform }} /p:OutputPath=bin\${{ matrix.platform }}\${{ matrix.configuration }}

    - name: Prepare ${{ matrix.configuration }} ${{ matrix.platform }} Package
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $config = "${{ matrix.configuration }}"
        $platform = "${{ matrix.platform }}"
        $outputPath = "SvonyBrowser/bin/$platform/$config"
        $packageName = "EvonyBrowser-v$version-win-$platform-$config"
        $packagePath = "packages-output/$packageName"
        
        # Create package directory
        New-Item -ItemType Directory -Path $packagePath -Force
        
        # Copy build output
        if (Test-Path $outputPath) {
          Copy-Item -Path "$outputPath/*" -Destination $packagePath -Recurse -Force
          Write-Host "Copied build output from $outputPath"
        } else {
          Write-Host "WARNING: Build output not found at $outputPath"
          exit 1
        }
        
        # Copy Assets folder
        if (Test-Path "release/Assets") {
          New-Item -ItemType Directory -Path "$packagePath/Assets" -Force
          Copy-Item -Path "release/Assets/*" -Destination "$packagePath/Assets" -Recurse -Force
          Write-Host "Copied Assets folder"
        }
        
        # Copy documentation
        if (Test-Path "docs") {
          Copy-Item -Path "docs" -Destination "$packagePath/docs" -Recurse -Force
        }
        
        # Copy README and LICENSE
        if (Test-Path "README.md") { Copy-Item -Path "README.md" -Destination $packagePath -Force }
        if (Test-Path "LICENSE") { Copy-Item -Path "LICENSE" -Destination $packagePath -Force }
        
        # Create ZIP archive
        Compress-Archive -Path "$packagePath/*" -DestinationPath "./$packageName.zip" -Force
        Write-Host "Created $packageName.zip"
        
        # Show package size
        $size = [math]::Round((Get-Item "./$packageName.zip").Length / 1MB, 2)
        Write-Host "Package size: $size MB"
      shell: pwsh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: EvonyBrowser-${{ matrix.platform }}-${{ matrix.configuration }}
        path: ./*.zip
        retention-days: 5

  build-portable:
    runs-on: windows-latest
    needs: build-windows
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout LFS objects
      run: git lfs pull

    - name: Get Version
      id: version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Build MCP Servers
      run: |
        $servers = @("evony-complete", "evony-rag", "evony-rte", "evony-tools", "evony-advanced", "evony-cdp", "evony-v4")
        foreach ($server in $servers) {
          $path = "mcp-servers/$server"
          if (Test-Path $path) {
            Push-Location $path
            npm install --production 2>$null
            Pop-Location
            Write-Host "Built MCP server: $server"
          }
        }
      shell: pwsh
      continue-on-error: true

    - name: Create Portable Package
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        
        # Create portable package with MCP servers
        $portablePath = "portable-package"
        New-Item -ItemType Directory -Path $portablePath -Force
        
        # Extract x64 Release build
        $x64Release = Get-ChildItem -Path "artifacts" -Recurse -Filter "*x64-Release.zip" | Select-Object -First 1
        if ($x64Release) {
          Expand-Archive -Path $x64Release.FullName -DestinationPath "$portablePath/app" -Force
          Write-Host "Extracted x64 Release build"
        }
        
        # Copy MCP servers
        if (Test-Path "mcp-servers") {
          Copy-Item -Path "mcp-servers" -Destination "$portablePath/mcp-servers" -Recurse -Force
          Write-Host "Copied MCP servers"
        }
        
        # Create launcher scripts
        $launcher1 = "@echo off`r`ncd /d `"%~dp0app`"`r`nstart `"`" `"SvonyBrowser.exe`""
        $launcher1 | Out-File -FilePath "$portablePath/Start-EvonyBrowser.bat" -Encoding ASCII
        
        $launcher2 = "@echo off`r`ncd /d `"%~dp0mcp-servers`"`r`necho Starting MCP servers...`r`npause"
        $launcher2 | Out-File -FilePath "$portablePath/Start-MCP-Servers.bat" -Encoding ASCII
        
        # Copy documentation
        if (Test-Path "README.md") { Copy-Item -Path "README.md" -Destination $portablePath -Force }
        if (Test-Path "LICENSE") { Copy-Item -Path "LICENSE" -Destination $portablePath -Force }
        if (Test-Path "docs") { Copy-Item -Path "docs" -Destination "$portablePath/docs" -Recurse -Force }
        
        # Create portable ZIP
        Compress-Archive -Path "$portablePath/*" -DestinationPath "./EvonyBrowser-v$version-portable.zip" -Force
        Write-Host "Created EvonyBrowser-v$version-portable.zip"
      shell: pwsh

    - name: Create Source Package
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        
        # Create clean source archive
        $excludePatterns = @(".git", "artifacts", "portable-package", "*.zip", "bin", "obj", "node_modules", "packages", ".vs")
        Get-ChildItem -Exclude $excludePatterns | Compress-Archive -DestinationPath "./EvonyBrowser-v$version-source.zip" -Force
        Write-Host "Created EvonyBrowser-v$version-source.zip"
      shell: pwsh

    - name: Create Assets Package
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        
        if (Test-Path "release/Assets") {
          Compress-Archive -Path "release/Assets/*" -DestinationPath "./EvonyBrowser-v$version-assets-only.zip" -Force
          Write-Host "Created EvonyBrowser-v$version-assets-only.zip"
        }
      shell: pwsh

    - name: Upload Portable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: EvonyBrowser-portable
        path: ./*.zip
        retention-days: 5

  create-release:
    runs-on: ubuntu-latest
    needs: [build-windows, build-portable]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Get Version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          version="${{ github.event.inputs.version }}"
        else
          tag="${{ github.ref_name }}"
          version="${tag#v}"
        fi
        echo "VERSION=$version" >> $GITHUB_OUTPUT
        echo "Version: $version"

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Prepare Release Files
      run: |
        mkdir -p release-files
        find release-artifacts -name "*.zip" -exec cp {} release-files/ \;
        ls -la release-files/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name || format('v{0}', steps.version.outputs.VERSION) }}
        name: Evony Browser v${{ steps.version.outputs.VERSION }}
        body: |
          ## üè∞ Evony Browser v${{ steps.version.outputs.VERSION }}
          
          ### üì• Downloads
          
          | Package | Description |
          |---------|-------------|
          | **win-x64-Release** | Windows 64-bit Release build (recommended) |
          | **win-x64-Debug** | Windows 64-bit Debug build with symbols |
          | **win-x86-Release** | Windows 32-bit Release build |
          | **win-x86-Debug** | Windows 32-bit Debug build with symbols |
          | **portable** | Self-contained package with MCP servers and launcher scripts |
          | **assets-only** | CefSharp DLLs, Flash plugin, and resources only |
          | **source** | Full source code |
          
          ### ‚ú® Features
          - CefSharp 84.4.10 with Flash Player support
          - Dual-panel browser for Evony gameplay
          - Session synchronization between panels
          - MCP server integration for AI assistance
          - Protocol analysis and debugging tools
          - SWF file player for Flash content
          
          ### üîß Requirements
          - Windows 10/11 (64-bit recommended)
          - Visual C++ Redistributable 2019 or later
          - .NET Framework 4.6.2 or later
          - Node.js 18+ (for MCP servers, optional)
          
          ### üìù Installation
          1. Download the appropriate package for your system
          2. Extract to a folder of your choice
          3. Run `SvonyBrowser.exe` (or `Start-EvonyBrowser.bat` for portable)
          
          See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for full documentation.
        files: release-files/*.zip
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
