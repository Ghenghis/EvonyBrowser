name: Build and Release V7.0

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  SOLUTION_PATH: SvonyBrowser/SvonyBrowser.csproj
  NODE_VERSION: '18.x'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout LFS objects
      run: git lfs pull

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Clear NuGet cache and restore packages
      run: |
        Write-Host "=== Clearing NuGet cache ==="
        nuget locals all -clear
        
        Write-Host "`n=== Removing existing packages folder ==="
        if (Test-Path packages) { Remove-Item packages -Recurse -Force }
        
        Write-Host "`n=== Installing CefSharp packages fresh ==="
        nuget install CefSharp.Common -Version 84.4.10 -OutputDirectory packages -NoCache
        nuget install CefSharp.Wpf -Version 84.4.10 -OutputDirectory packages -NoCache
        nuget install cef.redist.x64 -Version 84.4.1 -OutputDirectory packages -NoCache
        nuget install Newtonsoft.Json -Version 13.0.3 -OutputDirectory packages
        nuget install Serilog -Version 2.12.0 -OutputDirectory packages
        nuget install Serilog.Sinks.Console -Version 4.1.0 -OutputDirectory packages
        nuget install Serilog.Sinks.File -Version 5.0.0 -OutputDirectory packages
        nuget install System.ValueTuple -Version 4.5.0 -OutputDirectory packages
        
        Write-Host "`n=== Package folders ==="
        Get-ChildItem packages -Directory | ForEach-Object { Write-Host $_.Name }
        
        Write-Host "`n=== CefSharp DLLs ==="
        Get-ChildItem packages -Recurse -Filter "CefSharp*.dll" | ForEach-Object { Write-Host $_.FullName }
        
        Write-Host "`n=== Verifying critical DLLs ==="
        $cefDll = "packages/CefSharp.Common.84.4.10/CefSharp/x64/CefSharp.dll"
        if (Test-Path $cefDll) { 
          Write-Host "SUCCESS: $cefDll exists" 
        } else { 
          Write-Host "FAILED: $cefDll not found"
          Write-Host "Listing CefSharp.Common contents:"
          Get-ChildItem "packages/CefSharp.Common.84.4.10" -Recurse | ForEach-Object { Write-Host $_.FullName }
        }
      shell: pwsh

    - name: Build Release
      run: |
        msbuild ${{ env.SOLUTION_PATH }} /t:Build /p:Configuration=Release /p:Platform=x64

    - name: Build MCP Servers
      run: |
        $servers = @("evony-complete", "evony-rag", "evony-rte", "evony-tools", "evony-advanced", "evony-cdp", "evony-v4")
        foreach ($server in $servers) {
          $path = "mcp-servers/$server"
          if (Test-Path $path) {
            Write-Host "Building $server..."
            Push-Location $path
            npm install
            Pop-Location
          }
        }
      shell: pwsh
      continue-on-error: true

    - name: Verify MCP Server Syntax
      run: |
        $servers = @("evony-complete", "evony-rag", "evony-rte", "evony-tools", "evony-advanced", "evony-cdp", "evony-v4")
        foreach ($server in $servers) {
          $indexPath = "mcp-servers/$server/index.js"
          if (Test-Path $indexPath) {
            Write-Host "Checking syntax: $server"
            node -c $indexPath
          }
        }
      shell: pwsh
      continue-on-error: true

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EvonyBrowser-Build
        path: |
          SvonyBrowser/bin/x64/Release/
          mcp-servers/
        retention-days: 30
        if-no-files-found: warn
