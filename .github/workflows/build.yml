name: Build and Release V7.0

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  SOLUTION_PATH: SvonyBrowser/SvonyBrowser.csproj
  NODE_VERSION: '18.x'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Checkout LFS objects
      run: git lfs pull

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.config') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore NuGet packages
      run: |
        nuget restore ${{ env.SOLUTION_PATH }} -PackagesDirectory packages

    - name: Build Debug
      run: |
        msbuild ${{ env.SOLUTION_PATH }} /t:Build /p:Configuration=Debug /p:Platform=x64
      continue-on-error: true

    - name: Build Release
      run: |
        msbuild ${{ env.SOLUTION_PATH }} /t:Build /p:Configuration=Release /p:Platform=x64
      continue-on-error: true

    - name: Build MCP Servers
      run: |
        $servers = @("evony-complete", "evony-rag", "evony-rte", "evony-tools", "evony-advanced", "evony-cdp", "evony-v4")
        foreach ($server in $servers) {
          $path = "mcp-servers/$server"
          if (Test-Path $path) {
            Write-Host "Building $server..."
            Push-Location $path
            npm install
            Pop-Location
          }
        }
      shell: pwsh
      continue-on-error: true

    - name: Verify MCP Server Syntax
      run: |
        $servers = @("evony-complete", "evony-rag", "evony-rte", "evony-tools", "evony-advanced", "evony-cdp", "evony-v4")
        foreach ($server in $servers) {
          $indexPath = "mcp-servers/$server/index.js"
          if (Test-Path $indexPath) {
            Write-Host "Checking syntax: $server"
            node -c $indexPath
          }
        }
      shell: pwsh
      continue-on-error: true

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: EvonyBrowser-Build
        path: |
          SvonyBrowser/bin/x64/Release/
          mcp-servers/
        retention-days: 30
        if-no-files-found: warn
